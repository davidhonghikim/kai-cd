# 1. Architecture Overview

Kai-CD is architected as a modular, data-driven, single-page application packaged as a Chrome Extension. Its design prioritizes extensibility and a clean separation of concerns, allowing new features and services to be added with minimal changes to the core application logic.

The architecture is built on three fundamental principles:

1.  **Everything is a Service:** Every external tool (Ollama, ComfyUI, etc.) is treated as a "Service." All information required to interact with that service is encapsulated in a single, self-contained definition object.
2.  **The UI is a Function of State and Data:** The user interface is not static. It dynamically renders itself based on the capabilities and parameter schemas defined in a service's data. This eliminates the need for hardcoded UIs for each service.
3.  **Centralized State Management:** All application state is managed in a central location (Zustand stores), providing a single source of truth and predictable data flow.

## High-Level Diagram

This diagram illustrates the flow of data and control between the major components of the application.

```mermaid
graph TD
    subgraph Browser
        direction LR
        PopupUI[Popup UI<br/>(Popup.tsx)]
        SidePanelUI[Side Panel UI<br/>(Sidepanel.tsx)]
        TabUI[Main Tab UI<br/>(Tab.tsx)]
    end

    subgraph "Chrome Extension Backend"
        direction TB
        BackgroundScript[Background Script<br/>(main.ts)]
        subgraph "State Stores (Zustand)"
            ServiceStore[Service Store<br/>(serviceStore.ts)]
            ViewStateStore[View State Store<br/>(viewStateStore.ts)]
            SettingsStore[Settings Store<br/>(settingsStore.ts)]
        end
        ChromeStorage[chrome.storage.local]
    end

    subgraph "External World"
        direction TB
        Service1[Ollama API]
        Service2[A1111 API]
        Service3[...]
    end

    subgraph "Application Core"
        direction TB
        ApiClient[Universal API Client<br/>(apiClient.ts)]
        ServiceDefs[Service Definitions<br/>(connectors/definitions/*)]
        CapabilityUI[CapabilityUI Router<br/>(CapabilityUI.tsx)]
    end

    PopupUI -- "Open Service" --> BackgroundScript
    SidePanelUI -- "Renders Active Service" --> CapabilityUI
    TabUI -- "Renders Active Service" --> CapabilityUI

    BackgroundScript -- "Creates/Focuses Tab" --> TabUI
    BackgroundScript -- "Updates State" --> ServiceStore

    ServiceStore -- "Persists Data" --> ChromeStorage
    SettingsStore -- "Persists Data" --> ChromeStorage
    ServiceStore -- "Notifies" --> TabUI
    ViewStateStore -- "Notifies" --> TabUI

    CapabilityUI -- "Reads" --> ServiceDefs
    CapabilityUI -- "Uses" --> ApiClient

    ApiClient -- "Reads" --> ServiceDefs
    ApiClient -- "HTTP(S) Request" --> Service1
    ApiClient -- "HTTP(S) Request" --> Service2
    ApiClient -- "HTTP(S) Request" --> Service3
```

## Core Components

### 1. UI Entry Points (`popup`, `sidepanel`, `tab`)

-   **Purpose:** These are the three surfaces where a user can interact with the extension.
-   **`Popup.tsx`:** Acts as a quick-launch menu. It reads the list of configured services and provides buttons to open them in the main Tab or the Side Panel.
-   **`Sidepanel.tsx`:** A lightweight host for a single service's UI, intended for quick, context-specific tasks alongside a webpage.
-   **`Tab.tsx`:** The main, feature-rich application workspace. It contains the service management UI, settings, logs, and the primary capability views.

### 2. Background Script (`background/main.ts`)

-   **Purpose:** The central nervous system of the extension. It's a non-UI service worker that runs as long as the browser is open.
-   **Responsibilities:**
    -   **Routing:** Listens for messages from the Popup and orchestrates the opening and focusing of the main `tab.html`.
    -   **Initial State:** Passes initial state to newly created tabs to ensure they open to the correct view.

### 3. State Management (Zustand Stores)

-   **Purpose:** To provide a single, reliable source of truth for all application data.
-   **`serviceStore.ts`:** The most critical store. It holds the array of all user-configured services, including their definitions, credentials, and history. It handles the logic for adding, updating, and removing services, and persists this data to `chrome.storage.local`.
-   **`viewStateStore.ts`:** Manages the ephemeral UI state, such as which service or model is currently selected. This data is not persisted.
-   **`settingsStore.ts`:** Manages user preferences like theme and log level, persisting them to storage.
-   **`logStore.ts`:** Captures all logs generated by the application for display in the Console view.

### 4. Backend Connectors (`connectors/`)

-   **Purpose:** This is the heart of the application's extensibility.
-   **`definitions/`:** Contains the "Rich Service Definitions." Each file (e.g., `ollama.ts`) exports a JavaScript object that completely describes a service: its name, available capabilities (`llm_chat`, `image_generation`), API endpoints, and the schema for all its parameters.
-   **`apiClient.ts`:** A universal, singleton client that performs all `fetch` requests. It reads the endpoint information from a service definition to construct the correct URL, headers, and body for any given request. It also includes robust, centralized error handling and support for streaming responses.

### 5. Dynamic UI (`components/`)

-   **Purpose:** To render the correct user interface for any given service without hardcoding.
-   **`CapabilityUI.tsx`:** The "router" for the UI. It inspects the `capabilities` array of the currently active service.
-   **`registry.tsx`:** It looks up the primary capability in a registry that maps capability names (e.g., `'llm_chat'`) to React components (`LlmChatView`).
-   **Capability Views (`LlmChatView.tsx`, `ImageGenerationView.tsx`):** These components are responsible for rendering the full UI for a specific task. They use the `ParameterControl` component to dynamically generate the forms for adjusting API parameters.
-   **`ParameterControl.tsx`:** A generic component that renders the correct input (slider, toggle, dropdown, etc.) for a parameter based on its schema in the service definition.
-   **Dynamic Capabilities**: The `CapabilityUI.tsx` component dynamically renders the appropriate user interface based on the `capabilities` array of the active service.

### 6. State Management (Zustand)

State is managed via several Zustand stores, which are persisted to `chrome.storage.local`.

-   **`serviceStore`**: Manages all service configurations and statuses.
-   **`viewStateStore`**: Manages the UI state, like the active service and view.
-   **`settingsStore`**: Manages user settings like the theme.

For more details, see [03: State Management](./03_State_Management.md).

### 7. Credential & Vault Management

All sensitive credentials, such as API keys and bearer tokens, are managed through a centralized, zero-knowledge encrypted vault. This system is designed to be highly secure and user-friendly, inspired by the architecture of Bitwarden. All encryption and decryption happens client-side, and the storage backend never has access to unencrypted secrets.

For a complete breakdown of the vault's architecture and implementation, see [08: Credential & Vault Management](./08_Credential_And_Vault_Management.md). 